# Story 1.3: Database & Store Setup

## Status
Done

## Story
**As a** developer,
**I want** Dexie database and Zustand store configured,
**so that** data persists and state is managed consistently.

## Acceptance Criteria

| # | Critério |
|---|----------|
| AC1 | Dexie database com tabelas: boards, columns, tasks |
| AC2 | Schema com indexes corretos (boardId, columnId, order) |
| AC3 | Zustand store para UI state (activeBoardId, sidebarOpen, etc.) |
| AC4 | Zustand persist middleware configurado |
| AC5 | Custom hooks: `useBoard()`, `useTasks()`, `useColumns()` |
| AC6 | CRUD operations funcionando (create, read, update, delete) |

## Tasks / Subtasks

- [x] Task 1: Criar Dexie database (AC1, AC2)
  - [x] Criar src/db/index.ts com MiplanDB class
  - [x] Definir tabela boards: 'id, type, createdAt'
  - [x] Definir tabela columns: 'id, boardId, order'
  - [x] Definir tabela tasks: 'id, boardId, columnId, order, createdAt'
  - [x] Exportar instância db
- [x] Task 2: Criar Zustand store (AC3, AC4)
  - [x] Criar src/store/index.ts
  - [x] Definir state: activeBoardId, activeTimerTaskId, sidebarOpen, importModalOpen
  - [x] Definir actions: setActiveBoard, toggleSidebar, openImportModal, etc.
  - [x] Configurar persist middleware para localStorage
- [x] Task 3: Criar hook useBoard (AC5, AC6)
  - [x] Criar src/hooks/useBoard.ts
  - [x] Implementar getBoards()
  - [x] Implementar getBoard(id)
  - [x] Implementar createBoard(name, type)
  - [x] Implementar updateBoard(id, data)
  - [x] Implementar deleteBoard(id)
- [x] Task 4: Criar hook useColumns (AC5, AC6)
  - [x] Criar src/hooks/useColumns.ts
  - [x] Implementar getColumns(boardId)
  - [x] Implementar createColumn(boardId, title)
  - [x] Implementar updateColumn(id, data)
  - [x] Implementar deleteColumn(id)
  - [x] Implementar reorderColumns(boardId, columnIds)
- [x] Task 5: Criar hook useTasks (AC5, AC6)
  - [x] Criar src/hooks/useTasks.ts
  - [x] Implementar getTasks(boardId)
  - [x] Implementar getTasksByColumn(columnId)
  - [x] Implementar createTask(columnId, title)
  - [x] Implementar updateTask(id, data)
  - [x] Implementar deleteTask(id)
  - [x] Implementar moveTask(taskId, newColumnId, newOrder)

## Dev Notes

### Dexie Schema (de architecture.md)
```typescript
import Dexie, { Table } from 'dexie';
import { Board, Column, Task } from '../types';

export class MiplanDB extends Dexie {
  boards!: Table<Board>;
  columns!: Table<Column>;
  tasks!: Table<Task>;

  constructor() {
    super('miplan');
    this.version(1).stores({
      boards: 'id, type, createdAt',
      columns: 'id, boardId, order',
      tasks: 'id, boardId, columnId, order, createdAt'
    });
  }
}

export const db = new MiplanDB();
```

### Zustand Store (de architecture.md)
```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface UIState {
  activeBoardId: string | null;
  activeTimerTaskId: string | null;
  sidebarOpen: boolean;
  importModalOpen: boolean;
}

interface UIActions {
  setActiveBoard: (id: string) => void;
  toggleSidebar: () => void;
  openImportModal: () => void;
  closeImportModal: () => void;
  startTimer: (taskId: string) => void;
  stopTimer: () => void;
}
```

### Hook Pattern com dexie-react-hooks
```typescript
import { useLiveQuery } from 'dexie-react-hooks';
import { db } from '../db';

export const useBoard = (boardId: string) => {
  const board = useLiveQuery(
    () => db.boards.get(boardId),
    [boardId]
  );
  return board;
};
```

### Testing
- Criar board persiste no IndexedDB
- Criar task persiste no IndexedDB
- Refresh da página mantém dados
- Zustand state persiste (localStorage)

## Definition of Done
- [x] Criar board persiste no IndexedDB
- [x] Criar task persiste no IndexedDB
- [x] Refresh da página mantém dados
- [x] Zustand state persiste (localStorage)

## Story Points
3

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-31 | 0.1 | Story criada a partir do PRD | River (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A - No errors during implementation

### Completion Notes List
- Implemented Dexie database with MiplanDB class extending Dexie
- Created indexed tables: boards (id, type, createdAt), columns (id, boardId, order), tasks (id, boardId, columnId, order, createdAt)
- Implemented Zustand store with persist middleware using localStorage (key: miplan-ui-storage)
- Created reactive hooks using dexie-react-hooks useLiveQuery for automatic UI updates
- All CRUD operations implemented with proper transactions for cascade deletes
- moveTask handles reordering within same column and across columns

### File List
- `src/db/index.ts` - Dexie database class with boards, columns, tasks tables
- `src/store/index.ts` - Zustand UI store with persist middleware
- `src/hooks/useBoard.ts` - useBoards, useBoard, useBoardActions hooks
- `src/hooks/useColumns.ts` - useColumns, useColumn, useColumnActions hooks
- `src/hooks/useTasks.ts` - useTasks, useTasksByColumn, useTask, useTaskActions hooks

---

## QA Results
*To be filled by QA agent*
