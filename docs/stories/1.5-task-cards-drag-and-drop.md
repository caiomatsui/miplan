# Story 1.5: Task Cards & Drag-and-Drop

## Status
Done

## Story
**As a** user,
**I want** to drag tasks between columns,
**so that** I can update their status visually.

## Acceptance Criteria

| # | Critério |
|---|----------|
| AC1 | Tasks exibidas como cards dentro das colunas |
| AC2 | Cards são draggable usando @dnd-kit |
| AC3 | Colunas são droppable zones |
| AC4 | Drag-and-drop funcional entre todas as colunas |
| AC5 | Feedback visual durante drag (card elevado, placeholder) |
| AC6 | Reordenação de tasks dentro da mesma coluna |
| AC7 | Latência do drag < 100ms |
| AC8 | Funciona com mouse e touch |
| AC9 | Mudanças persistem no database |

## Tasks / Subtasks

- [x] Task 1: Criar componente TaskCard (AC1)
  - [x] Criar src/components/Task/TaskCard.tsx
  - [x] Exibir título da task
  - [x] Estilo card com shadow e rounded corners
  - [x] Altura mínima para fácil interação
- [x] Task 2: Configurar DndContext no Board (AC2, AC3, AC4)
  - [x] Importar DndContext, closestCorners de @dnd-kit/core
  - [x] Envolver Board com DndContext
  - [x] Configurar collision detection
- [x] Task 3: Criar hook useDragAndDrop (AC2, AC7, AC8)
  - [x] Criar src/hooks/useDragAndDrop.ts
  - [x] Configurar PointerSensor com activationConstraint
  - [x] Configurar KeyboardSensor para acessibilidade
  - [x] Exportar useDragSensors
- [x] Task 4: Tornar TaskCard draggable (AC2)
  - [x] Usar useSortable de @dnd-kit/sortable
  - [x] Aplicar transform e transition styles
  - [x] Adicionar drag handle (opcional)
- [x] Task 5: Tornar Column droppable (AC3)
  - [x] Usar useDroppable de @dnd-kit/core
  - [x] Configurar SortableContext para tasks
  - [x] Usar verticalListSortingStrategy
- [x] Task 6: Implementar feedback visual (AC5)
  - [x] DragOverlay para card sendo arrastado
  - [x] Estilo elevado (shadow maior, scale)
  - [x] Placeholder onde card será dropado
- [x] Task 7: Implementar handlers de drag (AC4, AC6)
  - [x] handleDragStart: setar activeId
  - [x] handleDragOver: mover task entre colunas
  - [x] handleDragEnd: finalizar e persistir
- [x] Task 8: Persistir mudanças (AC9)
  - [x] Atualizar columnId da task no database
  - [x] Atualizar order de todas tasks afetadas
  - [x] Usar transaction para atomicidade
- [x] Task 9: Testar touch (AC8)
  - [x] Verificar funcionamento em tablet/mobile
  - [x] Ajustar activation constraints se necessário

## Dev Notes

### @dnd-kit Setup (de architecture.md)
```typescript
import {
  DndContext,
  DragOverlay,
  closestCorners,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
} from '@dnd-kit/core';
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  verticalListSortingStrategy,
} from '@dnd-kit/sortable';

export const useDragSensors = () => {
  return useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8, // Prevents accidental drags
      },
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );
};
```

### Drag Event Handlers
```typescript
const handleDragStart = (event: DragStartEvent) => {
  setActiveId(event.active.id as string);
};

const handleDragOver = (event: DragOverEvent) => {
  const { active, over } = event;
  if (!over) return;

  const activeColumnId = active.data.current?.columnId;
  const overColumnId = over.data.current?.columnId || over.id;

  if (activeColumnId !== overColumnId) {
    moveTaskToColumn(active.id, overColumnId);
  }
};

const handleDragEnd = (event: DragEndEvent) => {
  setActiveId(null);
  persistChanges();
};
```

### TaskCard Component Structure
```typescript
interface TaskCardProps {
  task: Task;
  isDragging?: boolean;
}

export const TaskCard = ({ task, isDragging }: TaskCardProps) => {
  const { attributes, listeners, setNodeRef, transform, transition } = useSortable({
    id: task.id,
    data: { type: 'task', columnId: task.columnId }
  });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };

  return (
    <div ref={setNodeRef} style={style} {...attributes} {...listeners}>
      {task.title}
    </div>
  );
};
```

### Testing
- Drag task de "To Do" para "Done" funciona
- Reordenar tasks na mesma coluna funciona
- Após drag, ordem persiste no refresh
- Touch drag funciona em tablet

## Definition of Done
- [x] Drag task de "To Do" para "Done" funciona
- [x] Reordenar tasks na mesma coluna funciona
- [x] Após drag, ordem persiste no refresh
- [x] Touch drag funciona em tablet

## Story Points
5

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-31 | 0.1 | Story criada a partir do PRD | River (SM) |
| 2026-01-31 | 1.0 | Story implemented | Dex (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A - Implementation completed without errors

### Completion Notes List
- Created TaskCard component with useSortable hook for drag functionality
- Created TaskCardOverlay component for visual feedback during drag
- Created useDragAndDrop hook with PointerSensor, TouchSensor, and KeyboardSensor
- Updated Column component to be droppable with useDroppable and SortableContext
- Updated Board component with DndContext wrapper and all drag handlers
- Implemented optimistic UI updates during drag with local state
- Persist changes to database via existing moveTask function (uses Dexie transactions)
- Added CSS utilities for drag animations and touch support

### File List
| File | Action | Description |
|------|--------|-------------|
| src/components/Task/TaskCard.tsx | Created | Draggable task card with useSortable, includes TaskCardOverlay |
| src/hooks/useDragAndDrop.ts | Created | Sensors configuration (Pointer, Touch, Keyboard) |
| src/components/Board/Board.tsx | Updated | Added DndContext, DragOverlay, drag handlers |
| src/components/Board/Column.tsx | Updated | Added useDroppable, SortableContext, visual feedback |
| src/index.css | Updated | Added drag-related CSS utilities |

---

## QA Results
*To be filled by QA agent*
