# Story 3.2: URL Detection & Clickable Links

## Status
Done

## Story
**As a** user,
**I want** URLs in my tasks to be clickable,
**so that** I can quickly access the links I saved for study.

## Acceptance Criteria

| # | Crit√©rio |
|---|----------|
| AC1 | URLs no t√≠tulo s√£o detectadas automaticamente |
| AC2 | URLs renderizadas como links (azul, hover underline) |
| AC3 | Click no link abre em nova aba (target="_blank") |
| AC4 | √çcone üîó indica task com link (no card) |
| AC5 | URLs na descri√ß√£o tamb√©m s√£o detectadas |
| AC6 | Suporta: http://, https://, www. |
| AC7 | Click no link N√ÉO expande o card |
| AC8 | rel="noopener noreferrer" por seguran√ßa |

## Tasks / Subtasks

- [x] Task 1: Criar utilit√°rios de URL (AC1, AC6)
  - [x] Criar src/utils/url.ts
  - [x] detectUrls(text): string[] - retorna URLs encontradas
  - [x] hasUrl(text): boolean - verifica se tem URL
  - [x] normalizeUrl(url): string - adiciona https:// se necess√°rio
- [x] Task 2: Criar fun√ß√£o linkifyText (AC2, AC3, AC8)
  - [x] Em src/utils/url.ts
  - [x] linkifyText(text): ReactNode
  - [x] Retorna fragmentos de texto e <a> tags
  - [x] Links com target="_blank" rel="noopener noreferrer"
  - [x] Estilo: text-blue-600 hover:underline
- [x] Task 3: Atualizar TaskTitle (AC1, AC2, AC7)
  - [x] Usar linkifyText para renderizar t√≠tulo
  - [x] Click no link n√£o propaga para card (stopPropagation)
  - [x] Modo edi√ß√£o: texto puro (n√£o linkificado)
- [x] Task 4: Adicionar √≠cone de link no card (AC4)
  - [x] Atualizar TaskCard
  - [x] Se hasUrl(task.title) ou hasUrl(task.description)
  - [x] Mostrar √≠cone üîó no canto do card
  - [x] Tooltip: "Contains link"
- [x] Task 5: Atualizar TaskDescription (AC5)
  - [x] Usar linkifyText para renderizar descri√ß√£o
  - [x] Mesma l√≥gica do t√≠tulo
  - [x] Modo edi√ß√£o: texto puro
- [x] Task 6: Testar diferentes formatos de URL (AC6)
  - [x] https://example.com
  - [x] http://example.com
  - [x] www.example.com
  - [x] URLs com paths e query strings

## Dev Notes

### URL Detection (de architecture.md)
```typescript
// src/utils/url.ts
const URL_REGEX = /https?:\/\/[^\s<>\"']+|www\.[^\s<>\"']+/gi;

export const detectUrls = (text: string): string[] => {
  return text.match(URL_REGEX) || [];
};

export const hasUrl = (text: string): boolean => {
  return URL_REGEX.test(text);
};

export const normalizeUrl = (url: string): string => {
  if (url.startsWith('www.')) {
    return `https://${url}`;
  }
  return url;
};
```

### linkifyText Function
```typescript
import React, { ReactNode } from 'react';

export const linkifyText = (text: string): ReactNode => {
  const urlRegex = /https?:\/\/[^\s<>\"']+|www\.[^\s<>\"']+/gi;
  const parts: ReactNode[] = [];
  let lastIndex = 0;
  let match;

  // Reset regex
  urlRegex.lastIndex = 0;

  while ((match = urlRegex.exec(text)) !== null) {
    // Add text before the URL
    if (match.index > lastIndex) {
      parts.push(text.slice(lastIndex, match.index));
    }

    // Add the URL as a link
    const url = match[0];
    const href = normalizeUrl(url);
    parts.push(
      <a
        key={match.index}
        href={href}
        target="_blank"
        rel="noopener noreferrer"
        className="text-blue-600 hover:underline"
        onClick={(e) => e.stopPropagation()}
      >
        {url}
      </a>
    );

    lastIndex = match.index + match[0].length;
  }

  // Add remaining text
  if (lastIndex < text.length) {
    parts.push(text.slice(lastIndex));
  }

  return parts.length > 0 ? <>{parts}</> : text;
};
```

### TaskCard with Link Icon
```typescript
export const TaskCard = ({ task }: TaskCardProps) => {
  const hasLink = hasUrl(task.title) || hasUrl(task.description);

  return (
    <div className="...">
      {hasLink && (
        <span className="absolute top-2 right-2" title="Contains link">
          üîó
        </span>
      )}
      <TaskTitle task={task} />
      {/* ... */}
    </div>
  );
};
```

### Prevent Card Expand on Link Click
```typescript
// No link dentro de TaskTitle
<a
  href={href}
  onClick={(e) => {
    e.stopPropagation(); // N√£o propaga para o card
  }}
>
  {url}
</a>
```

### Testing
- URLs no t√≠tulo s√£o clic√°veis
- URLs na descri√ß√£o s√£o clic√°veis
- Links abrem em nova aba
- √çcone üîó aparece em cards com URL
- Click no link n√£o conflita com card expand

## Definition of Done
- [x] URLs no t√≠tulo s√£o clic√°veis
- [x] URLs na descri√ß√£o s√£o clic√°veis
- [x] Links abrem em nova aba
- [x] √çcone üîó aparece em cards com URL
- [x] Click no link n√£o conflita com card expand

## Story Points
3

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-31 | 0.1 | Story criada a partir do PRD | River (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A - Implementation completed without errors

### Completion Notes List
1. Created URL utility module with all required functions (detectUrls, hasUrl, normalizeUrl, linkifyText)
2. Updated TaskTitle to display linkified text in display mode, plain text in edit mode
3. Updated TaskDescription to toggle between display mode (with linkified text) and edit mode (textarea)
4. Added link icon indicator to TaskCard when task contains URLs in title or description
5. All links open in new tab with target="_blank" rel="noopener noreferrer"
6. Click on links calls stopPropagation() to prevent card expand
7. URL regex supports http://, https://, and www. prefixes
8. www. URLs are normalized to https://www.

### File List
| File | Action | Description |
|------|--------|-------------|
| `src/utils/url.ts` | Created | URL detection and linkification utilities |
| `src/components/Task/TaskTitle.tsx` | Modified | Added linkifyText for display mode |
| `src/components/Task/TaskDescription.tsx` | Modified | Added display/edit mode toggle with linkifyText |
| `src/components/Task/TaskCard.tsx` | Modified | Added link icon indicator and linkified collapsed description |

---

## QA Results
*To be filled by QA agent*
