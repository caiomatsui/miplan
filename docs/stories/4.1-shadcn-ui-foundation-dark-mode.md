# Story 4.1: shadcn/ui Foundation & Dark Mode

## Status
Ready for Review

## Story
**As a** user,
**I want** a polished UI with dark mode support,
**so that** I have a modern, comfortable viewing experience day or night.

## Acceptance Criteria

| # | Criterion |
|---|-----------|
| AC1 | shadcn/ui CLI installed and configured for project |
| AC2 | CSS variables system using shadcn conventions (oklch colors) |
| AC3 | Light theme is default with proper color tokens |
| AC4 | Dark theme with proper contrast and readability |
| AC5 | Theme toggle button in Header |
| AC6 | Theme preference persists in localStorage |
| AC7 | System preference detection (prefers-color-scheme) on first visit |
| AC8 | Smooth transition when switching themes (no flash) |
| AC9 | All existing components work in both themes |
| AC10 | cn() utility function available for className merging |

## Tasks / Subtasks

- [x] Task 1: Install shadcn/ui dependencies (AC1, AC10)
  - [x] Install required packages: `class-variance-authority`, `clsx`, `tailwind-merge`
  - [x] Create `src/lib/utils.ts` with cn() function
  - [x] Configure path aliases in vite.config.ts (@/ -> src/)
  - [x] Create `components.json` for shadcn CLI config

- [x] Task 2: Update CSS variables system (AC2, AC3, AC4)
  - [x] Replace current index.css variables with shadcn theme format
  - [x] Define :root (light) theme with all color tokens
  - [x] Define .dark theme with all color tokens
  - [x] Include: background, foreground, card, popover, primary, secondary, muted, accent, destructive, border, input, ring
  - [x] Use oklch color format for modern color handling

- [x] Task 3: Create ThemeProvider (AC5, AC6, AC7, AC8)
  - [x] Create `src/components/ThemeProvider.tsx`
  - [x] Implement useTheme hook with localStorage persistence
  - [x] Detect system preference on first visit
  - [x] Add/remove .dark class on document.documentElement
  - [x] Prevent flash on page load (script in index.html)

- [x] Task 4: Add theme toggle to Header (AC5)
  - [x] Create toggle button with sun/moon icons
  - [x] Place in Header component (right side)
  - [x] Accessible button with aria-label

- [x] Task 5: Update existing components for theme compatibility (AC9)
  - [x] Update TaskCard: use bg-card, text-card-foreground, border-border
  - [x] Update Column: use bg-background, text-foreground
  - [x] Update Header: use bg-background, border-border
  - [x] Update Sidebar: use bg-sidebar, text-sidebar-foreground
  - [x] Update Modal: use bg-popover, text-popover-foreground
  - [x] Update Button: use primary/secondary variants
  - [x] Update Input: use bg-input, border-input

- [x] Task 6: Verify all states work in both themes (AC9)
  - [x] Hover states
  - [x] Focus states
  - [x] Active/selected states
  - [x] Disabled states
  - [x] Drag overlay states

## Dev Notes

### Required Packages
```bash
npm install class-variance-authority clsx tailwind-merge
```

### cn() Utility (src/lib/utils.ts)
```typescript
import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
```

### Vite Config Path Alias
```typescript
// vite.config.ts
import path from "path"

export default defineConfig({
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
})
```

### CSS Variables Structure (index.css)
```css
@import "tailwindcss";

:root {
  --radius: 0.5rem;
  --background: oklch(1 0 0);
  --foreground: oklch(0.145 0 0);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.145 0 0);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.145 0 0);
  --primary: oklch(0.205 0 0);
  --primary-foreground: oklch(0.985 0 0);
  --secondary: oklch(0.97 0 0);
  --secondary-foreground: oklch(0.205 0 0);
  --muted: oklch(0.97 0 0);
  --muted-foreground: oklch(0.556 0 0);
  --accent: oklch(0.97 0 0);
  --accent-foreground: oklch(0.205 0 0);
  --destructive: oklch(0.577 0.245 27.325);
  --border: oklch(0.922 0 0);
  --input: oklch(0.922 0 0);
  --ring: oklch(0.708 0 0);
  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.145 0 0);
}

.dark {
  --background: oklch(0.145 0 0);
  --foreground: oklch(0.985 0 0);
  --card: oklch(0.205 0 0);
  --card-foreground: oklch(0.985 0 0);
  --popover: oklch(0.269 0 0);
  --popover-foreground: oklch(0.985 0 0);
  --primary: oklch(0.922 0 0);
  --primary-foreground: oklch(0.205 0 0);
  --secondary: oklch(0.269 0 0);
  --secondary-foreground: oklch(0.985 0 0);
  --muted: oklch(0.269 0 0);
  --muted-foreground: oklch(0.708 0 0);
  --accent: oklch(0.371 0 0);
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: oklch(0.556 0 0);
  --sidebar: oklch(0.205 0 0);
  --sidebar-foreground: oklch(0.985 0 0);
}
```

### ThemeProvider Pattern
```typescript
// src/components/ThemeProvider.tsx
import { createContext, useContext, useEffect, useState } from 'react'

type Theme = 'light' | 'dark' | 'system'

interface ThemeContextType {
  theme: Theme
  setTheme: (theme: Theme) => void
}

const ThemeContext = createContext<ThemeContextType | undefined>(undefined)

export function ThemeProvider({ children }: { children: React.ReactNode }) {
  const [theme, setTheme] = useState<Theme>(() => {
    return (localStorage.getItem('theme') as Theme) || 'system'
  })

  useEffect(() => {
    const root = document.documentElement
    root.classList.remove('light', 'dark')

    if (theme === 'system') {
      const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches
        ? 'dark'
        : 'light'
      root.classList.add(systemTheme)
    } else {
      root.classList.add(theme)
    }

    localStorage.setItem('theme', theme)
  }, [theme])

  return (
    <ThemeContext.Provider value={{ theme, setTheme }}>
      {children}
    </ThemeContext.Provider>
  )
}

export const useTheme = () => {
  const context = useContext(ThemeContext)
  if (!context) throw new Error('useTheme must be used within ThemeProvider')
  return context
}
```

### Prevent Flash Script (index.html)
Add before </head>:
```html
<script>
  (function() {
    const theme = localStorage.getItem('theme') || 'system';
    const isDark = theme === 'dark' ||
      (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
    if (isDark) document.documentElement.classList.add('dark');
  })();
</script>
```

### Tailwind Config Update
```javascript
// tailwind.config.js
export default {
  darkMode: 'class',
  content: ["./index.html", "./src/**/*.{js,ts,jsx,tsx}"],
  theme: {
    extend: {
      colors: {
        background: 'oklch(var(--background))',
        foreground: 'oklch(var(--foreground))',
        card: { DEFAULT: 'oklch(var(--card))', foreground: 'oklch(var(--card-foreground))' },
        // ... map all CSS variables
      },
    },
  },
}
```

### Testing
- Toggle works and persists on refresh
- System preference detected on first visit
- No flash of wrong theme on load
- All components readable in both themes
- Hover/focus states visible in both themes

## Story Points
5

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-31 | 0.1 | Story created from UI brainstorming session | River (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Build passed successfully with no TypeScript errors
- All components updated to use CSS variable-based theming

### Completion Notes List
- Installed class-variance-authority, clsx, tailwind-merge packages
- Created cn() utility for className merging (shadcn pattern)
- Configured path aliases (@/ -> src/) in vite.config.ts and tsconfig.json
- Created components.json for shadcn CLI compatibility
- Implemented complete CSS variables system with oklch colors for light/dark themes
- Created ThemeProvider with system preference detection and localStorage persistence
- Added flash prevention script in index.html
- Implemented theme toggle in Header with cycling through light/dark/system
- Updated all 20+ components to use theme-aware CSS variable classes
- Build compiles successfully with no errors

### File List
**Created:**
- src/lib/utils.ts (cn utility function)
- src/components/ThemeProvider.tsx (theme context and hook)
- components.json (shadcn CLI config)

**Modified:**
- vite.config.ts (path alias)
- tsconfig.json (path mapping)
- tailwind.config.js (darkMode class, color mappings)
- index.html (flash prevention script)
- src/index.css (CSS variables system)
- src/main.tsx (ThemeProvider wrapper)
- src/App.tsx (theme classes)
- src/components/Header/Header.tsx (theme toggle, theme classes)
- src/components/Sidebar/Sidebar.tsx (theme classes)
- src/components/Sidebar/BoardList.tsx (theme classes)
- src/components/Sidebar/BoardItem.tsx (theme classes)
- src/components/Sidebar/AddBoardButton.tsx (theme classes)
- src/components/Board/Board.tsx (theme classes)
- src/components/Board/Column.tsx (theme classes)
- src/components/Board/ColumnHeader.tsx (theme classes)
- src/components/Board/ColumnOverlay.tsx (theme classes)
- src/components/Board/ColumnMenu.tsx (theme classes)
- src/components/Board/AddColumn.tsx (theme classes)
- src/components/Board/CreateBoardModal.tsx (theme classes)
- src/components/Task/TaskCard.tsx (theme classes)
- src/components/Task/TaskTitle.tsx (theme classes)
- src/components/Task/TaskDescription.tsx (theme classes)
- src/components/Task/TaskTimer.tsx (theme classes)
- src/components/Task/TaskActions.tsx (theme classes)
- src/components/ui/Modal.tsx (theme classes)
- src/components/ui/Toast.tsx (theme classes)
- src/components/ui/Button.tsx (theme variants)
- src/components/ui/Input.tsx (theme classes)
- src/components/ui/ConfirmDialog.tsx (theme classes)
- src/components/Import/ImportModal.tsx (theme classes)
- src/components/Import/ImportPreview.tsx (theme classes)
- src/components/Import/FileDropzone.tsx (theme classes)

---

## QA Results

### Gate Decision: **PASS**

**Reviewed by:** Quinn (QA Agent)
**Date:** 2026-01-31

### Acceptance Criteria Verification

| AC | Criterion | Status | Notes |
|----|-----------|--------|-------|
| AC1 | shadcn/ui CLI configured | PASS | components.json created, dependencies installed |
| AC2 | CSS variables with oklch | PASS | Full variable system in index.css |
| AC3 | Light theme default | PASS | :root defines light theme colors |
| AC4 | Dark theme with contrast | PASS | .dark class with proper color tokens |
| AC5 | Theme toggle in Header | PASS | Cycling toggle with sun/moon/monitor icons |
| AC6 | localStorage persistence | PASS | ThemeProvider saves to 'miplan-theme' |
| AC7 | System preference detection | PASS | prefers-color-scheme detected on first visit |
| AC8 | Smooth transitions | PASS | CSS transitions + flash prevention script |
| AC9 | All components themed | PASS | 30+ components updated |
| AC10 | cn() utility available | PASS | src/lib/utils.ts created |

### Build Verification
- TypeScript compilation: **PASS**
- Vite build: **PASS** (699KB bundle)

### Notes
- Bundle size (699KB) triggers Vite warning - acceptable for MVP, consider code splitting for future optimization
- Comprehensive theme implementation covering all UI components
