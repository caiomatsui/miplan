# Story 4.2: Task Priority Badges

## Status
Ready for Review

## Story
**As a** user,
**I want** to assign priority levels to tasks with visual badges,
**so that** I can quickly identify which tasks need immediate attention.

## Acceptance Criteria

| # | Criterion |
|---|-----------|
| AC1 | Priority field added to Task data model (high, medium, low, none) |
| AC2 | Priority badge displays on TaskCard with color coding |
| AC3 | High = red badge, Medium = yellow badge, Low = green badge, None = no badge |
| AC4 | Priority selector in expanded TaskCard view |
| AC5 | Priority persists in database |
| AC6 | Default priority for new tasks is "none" |
| AC7 | Badge uses shadcn Badge component styling |
| AC8 | Badge visible in both light and dark themes |
| AC9 | Priority can be changed without expanding card (quick action) |

## Tasks / Subtasks

- [x] Task 1: Update data model (AC1, AC5, AC6)
  - [x] Add `priority` field to Task interface: `'high' | 'medium' | 'low' | 'none'`
  - [x] Update Dexie schema version
  - [x] Add migration for existing tasks (default to 'none')
  - [x] Update createTask to set default priority

- [x] Task 2: Create Badge component (AC7, AC8)
  - [x] Create `src/components/ui/Badge.tsx`
  - [x] Use class-variance-authority for variants
  - [x] Variants: default, destructive (high), warning (medium), success (low)
  - [x] Support light/dark themes via CSS variables

- [x] Task 3: Create PriorityBadge component (AC2, AC3, AC8)
  - [x] Create `src/components/Task/PriorityBadge.tsx`
  - [x] Map priority to badge variant and label
  - [x] High: "High" with destructive variant
  - [x] Medium: "Med" with warning variant
  - [x] Low: "Low" with success variant
  - [x] None: render nothing

- [x] Task 4: Create PrioritySelector component (AC4, AC9)
  - [x] Create `src/components/Task/PrioritySelector.tsx`
  - [x] Dropdown with priority options
  - [x] Color indicators in dropdown
  - [x] Click outside to close
  - [x] Keyboard accessible

- [x] Task 5: Integrate into TaskCard (AC2, AC4, AC9)
  - [x] Show PriorityBadge in collapsed view (top-left corner)
  - [x] Show PrioritySelector in expanded view
  - [x] Add quick-change button (hover) in collapsed view
  - [x] Update task on priority change

- [x] Task 6: Update hooks (AC5)
  - [x] Update useTaskActions.updateTask to handle priority
  - [x] Ensure priority changes trigger re-render

## Dev Notes

### Priority Type Definition
```typescript
// src/types/index.ts
export type TaskPriority = 'high' | 'medium' | 'low' | 'none';

export interface Task {
  // ... existing fields
  priority: TaskPriority;
}
```

### Dexie Migration
```typescript
// src/database/db.ts
// Increment version and add upgrade
db.version(2).stores({
  tasks: '++id, boardId, columnId, order, priority',
}).upgrade(tx => {
  return tx.table('tasks').toCollection().modify(task => {
    if (!task.priority) task.priority = 'none';
  });
});
```

### Badge Component (shadcn-style)
```typescript
// src/components/ui/Badge.tsx
import { cva, type VariantProps } from 'class-variance-authority'
import { cn } from '@/lib/utils'

const badgeVariants = cva(
  "inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium transition-colors",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground",
        secondary: "bg-secondary text-secondary-foreground",
        destructive: "bg-red-500 text-white dark:bg-red-600",
        warning: "bg-yellow-500 text-black dark:bg-yellow-600 dark:text-white",
        success: "bg-green-500 text-white dark:bg-green-600",
        outline: "border border-border text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

interface BadgeProps
  extends React.HTMLAttributes<HTMLSpanElement>,
    VariantProps<typeof badgeVariants> {}

export function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <span className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}
```

### PriorityBadge Component
```typescript
// src/components/Task/PriorityBadge.tsx
import { Badge } from '@/components/ui/Badge'
import { TaskPriority } from '@/types'

const priorityConfig = {
  high: { label: 'High', variant: 'destructive' as const },
  medium: { label: 'Med', variant: 'warning' as const },
  low: { label: 'Low', variant: 'success' as const },
  none: null,
}

interface PriorityBadgeProps {
  priority: TaskPriority
  size?: 'sm' | 'default'
}

export function PriorityBadge({ priority, size = 'default' }: PriorityBadgeProps) {
  const config = priorityConfig[priority]
  if (!config) return null

  return (
    <Badge
      variant={config.variant}
      className={size === 'sm' ? 'text-[10px] px-1.5 py-0' : ''}
    >
      {config.label}
    </Badge>
  )
}
```

### PrioritySelector Component
```typescript
// src/components/Task/PrioritySelector.tsx
import { useState, useRef, useEffect } from 'react'
import { TaskPriority } from '@/types'

const priorities: { value: TaskPriority; label: string; color: string }[] = [
  { value: 'high', label: 'High', color: 'bg-red-500' },
  { value: 'medium', label: 'Medium', color: 'bg-yellow-500' },
  { value: 'low', label: 'Low', color: 'bg-green-500' },
  { value: 'none', label: 'None', color: 'bg-gray-300' },
]

interface PrioritySelectorProps {
  value: TaskPriority
  onChange: (priority: TaskPriority) => void
}

export function PrioritySelector({ value, onChange }: PrioritySelectorProps) {
  const [open, setOpen] = useState(false)
  const ref = useRef<HTMLDivElement>(null)

  // Close on outside click
  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (ref.current && !ref.current.contains(e.target as Node)) {
        setOpen(false)
      }
    }
    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  const current = priorities.find(p => p.value === value) || priorities[3]

  return (
    <div ref={ref} className="relative">
      <button
        onClick={(e) => { e.stopPropagation(); setOpen(!open) }}
        className="flex items-center gap-2 px-2 py-1 rounded hover:bg-muted"
      >
        <span className={`w-2 h-2 rounded-full ${current.color}`} />
        <span className="text-sm">{current.label}</span>
      </button>

      {open && (
        <div className="absolute top-full left-0 mt-1 bg-popover border border-border rounded-md shadow-lg z-50 py-1 min-w-[120px]">
          {priorities.map((p) => (
            <button
              key={p.value}
              onClick={(e) => {
                e.stopPropagation()
                onChange(p.value)
                setOpen(false)
              }}
              className="flex items-center gap-2 w-full px-3 py-1.5 hover:bg-accent text-left"
            >
              <span className={`w-2 h-2 rounded-full ${p.color}`} />
              <span className="text-sm">{p.label}</span>
              {p.value === value && <span className="ml-auto">✓</span>}
            </button>
          ))}
        </div>
      )}
    </div>
  )
}
```

### TaskCard Integration
```tsx
// In TaskCard collapsed view (top-left)
{task.priority !== 'none' && (
  <div className="absolute top-2 left-2">
    <PriorityBadge priority={task.priority} size="sm" />
  </div>
)}

// In TaskCard expanded view
<div className="mt-2 flex items-center gap-2">
  <span className="text-sm text-muted-foreground">Priority:</span>
  <PrioritySelector
    value={task.priority}
    onChange={(priority) => updateTask(task.id, { priority })}
  />
</div>
```

### Testing
- Priority badge shows correct color for each level
- Priority persists after page refresh
- New tasks default to "none" priority
- Badge visible in both light and dark themes
- Selector works with keyboard navigation
- Priority change updates immediately

## Story Points
3

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-31 | 0.1 | Story created from UI brainstorming session | River (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- TypeScript compilation passed with no errors
- Build completed successfully

### Completion Notes List
- Added TaskPriority type and priority field to Task interface
- Updated Dexie schema to version 2 with migration for existing tasks
- Created Badge component with class-variance-authority variants
- Created PriorityBadge component with color-coded priority display
- Created PrioritySelector dropdown with keyboard accessibility
- Integrated priority badge in TaskCard collapsed view (top-left)
- Added PrioritySelector in TaskCard expanded view
- Updated TaskCardOverlay to show priority badge

### File List
**Created:**
- src/components/ui/Badge.tsx
- src/components/Task/PriorityBadge.tsx
- src/components/Task/PrioritySelector.tsx

**Modified:**
- src/types/index.ts (added TaskPriority type, priority field)
- src/db/index.ts (version 2 schema, migration)
- src/hooks/useTasks.ts (default priority in createTask)
- src/components/Task/TaskCard.tsx (priority badge/selector integration)

---

## QA Results

### Gate Decision: **PASS**

**Reviewed by:** Quinn (QA Agent)
**Date:** 2026-01-31

### Acceptance Criteria Verification

| AC | Criterion | Status | Notes |
|----|-----------|--------|-------|
| AC1 | Priority field in data model | PASS | TaskPriority type added to types/index.ts |
| AC2 | Priority badge on TaskCard | PASS | PriorityBadge integrated in collapsed view |
| AC3 | Color coding (high=red, med=yellow, low=green) | PASS | Badge variants with correct colors |
| AC4 | Priority selector in expanded view | PASS | PrioritySelector dropdown created |
| AC5 | Database persistence | PASS | Dexie v2 migration with priority index |
| AC6 | Default priority "none" | PASS | createTask sets priority: 'none' |
| AC7 | shadcn Badge styling | PASS | CVA variants pattern used |
| AC8 | Works in light/dark themes | PASS | Badge uses theme-compatible colors |
| AC9 | Quick action priority change | PASS | Selector works without full expansion |

### Build Verification
- TypeScript compilation: **PASS**
- Database migration: **PASS** (v1 → v2)

### Notes
- Clean implementation following shadcn patterns
- Dexie migration properly handles existing tasks
