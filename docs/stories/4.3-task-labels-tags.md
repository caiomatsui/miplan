# Story 4.3: Task Labels/Tags System

## Status
Ready for Review

## Story
**As a** user,
**I want** to create and assign custom colored labels to tasks,
**so that** I can organize and categorize my work visually.

## Acceptance Criteria

| # | Criterion |
|---|-----------|
| AC1 | Labels table in database with id, boardId, name, color |
| AC2 | TaskLabels join table for many-to-many relationship |
| AC3 | Label management UI (create, edit, delete) accessible from board |
| AC4 | Pre-defined color palette (8-10 colors) for labels |
| AC5 | Labels display on TaskCard as small colored pills |
| AC6 | Label picker in expanded TaskCard view |
| AC7 | Multiple labels can be assigned to a single task |
| AC8 | Labels are board-specific (not shared across boards) |
| AC9 | Labels work in both light and dark themes |
| AC10 | Maximum 5 labels visible on collapsed card ("+N more" if exceeded) |

## Tasks / Subtasks

- [x] Task 1: Create Label data model (AC1, AC2, AC8)
  - [x] Add Label interface: id, boardId, name, color
  - [x] Add TaskLabel interface: taskId, labelId
  - [x] Update Dexie schema with labels and taskLabels tables
  - [x] Create indexes for efficient querying

- [x] Task 2: Create Label hooks (AC1, AC8)
  - [x] Create `src/hooks/useLabels.ts`
  - [x] useLabels(boardId): get all labels for board
  - [x] useLabelActions(): createLabel, updateLabel, deleteLabel
  - [x] useTaskLabels(taskId): get labels for a task
  - [x] useTaskLabelActions(): addLabelToTask, removeLabelFromTask

- [x] Task 3: Define color palette (AC4, AC9)
  - [x] Create `src/constants/labelColors.ts`
  - [x] 10 colors with light/dark variants
  - [x] Colors: red, orange, yellow, green, teal, blue, indigo, purple, pink, gray

- [x] Task 4: Create LabelBadge component (AC5, AC9)
  - [x] Create `src/components/Task/LabelBadge.tsx`
  - [x] Small pill with background color and text
  - [x] Text color based on background luminance
  - [x] Optional small size variant

- [x] Task 5: Create LabelPicker component (AC6, AC7)
  - [x] Create `src/components/Task/LabelPicker.tsx`
  - [x] List all board labels with checkboxes
  - [x] "Create new label" option at bottom
  - [x] Search/filter labels
  - [x] Accessible dropdown

- [x] Task 6: Create LabelManager component (AC3)
  - [x] Create `src/components/Board/LabelManager.tsx`
  - [x] Modal accessible from Board header or column menu
  - [x] List all labels with edit/delete options
  - [x] Create new label form
  - [x] Color picker from palette
  - [x] Confirmation before delete

- [x] Task 7: Integrate labels into TaskCard (AC5, AC6, AC10)
  - [x] Show label badges in collapsed view
  - [x] Limit to 5 visible with "+N" overflow
  - [x] Show LabelPicker in expanded view
  - [x] Click label badge to open picker

- [x] Task 8: Add "Manage Labels" to board UI (AC3)
  - [x] Add button in Board header or dropdown
  - [x] Open LabelManager modal

## Dev Notes

### Type Definitions
```typescript
// src/types/index.ts
export interface Label {
  id: string;
  boardId: string;
  name: string;
  color: string; // hex color
  createdAt: number;
}

export interface TaskLabel {
  id: string;
  taskId: string;
  labelId: string;
}
```

### Dexie Schema Update
```typescript
// src/database/db.ts
db.version(3).stores({
  boards: '++id',
  columns: '++id, boardId, order',
  tasks: '++id, boardId, columnId, order',
  labels: '++id, boardId',
  taskLabels: '++id, taskId, labelId, [taskId+labelId]',
});
```

### Color Palette
```typescript
// src/constants/labelColors.ts
export const LABEL_COLORS = [
  { name: 'Red', value: '#EF4444', dark: '#DC2626' },
  { name: 'Orange', value: '#F97316', dark: '#EA580C' },
  { name: 'Yellow', value: '#EAB308', dark: '#CA8A04' },
  { name: 'Green', value: '#22C55E', dark: '#16A34A' },
  { name: 'Teal', value: '#14B8A6', dark: '#0D9488' },
  { name: 'Blue', value: '#3B82F6', dark: '#2563EB' },
  { name: 'Indigo', value: '#6366F1', dark: '#4F46E5' },
  { name: 'Purple', value: '#A855F7', dark: '#9333EA' },
  { name: 'Pink', value: '#EC4899', dark: '#DB2777' },
  { name: 'Gray', value: '#6B7280', dark: '#4B5563' },
] as const;

// Helper to determine text color based on background
export function getContrastColor(hexColor: string): 'white' | 'black' {
  const r = parseInt(hexColor.slice(1, 3), 16);
  const g = parseInt(hexColor.slice(3, 5), 16);
  const b = parseInt(hexColor.slice(5, 7), 16);
  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  return luminance > 0.5 ? 'black' : 'white';
}
```

### useLabels Hook
```typescript
// src/hooks/useLabels.ts
import { useLiveQuery } from 'dexie-react-hooks';
import { db } from '@/database/db';
import { nanoid } from 'nanoid';

export function useLabels(boardId: string | null) {
  return useLiveQuery(
    () => boardId ? db.labels.where('boardId').equals(boardId).toArray() : [],
    [boardId]
  );
}

export function useTaskLabels(taskId: string) {
  return useLiveQuery(async () => {
    const taskLabels = await db.taskLabels.where('taskId').equals(taskId).toArray();
    const labelIds = taskLabels.map(tl => tl.labelId);
    return db.labels.where('id').anyOf(labelIds).toArray();
  }, [taskId]);
}

export function useLabelActions() {
  const createLabel = async (boardId: string, name: string, color: string) => {
    const id = nanoid();
    await db.labels.add({ id, boardId, name, color, createdAt: Date.now() });
    return id;
  };

  const addLabelToTask = async (taskId: string, labelId: string) => {
    const existing = await db.taskLabels
      .where({ taskId, labelId })
      .first();
    if (!existing) {
      await db.taskLabels.add({ id: nanoid(), taskId, labelId });
    }
  };

  const removeLabelFromTask = async (taskId: string, labelId: string) => {
    await db.taskLabels.where({ taskId, labelId }).delete();
  };

  const deleteLabel = async (labelId: string) => {
    await db.transaction('rw', [db.labels, db.taskLabels], async () => {
      await db.taskLabels.where('labelId').equals(labelId).delete();
      await db.labels.delete(labelId);
    });
  };

  return { createLabel, addLabelToTask, removeLabelFromTask, deleteLabel };
}
```

### LabelBadge Component
```typescript
// src/components/Task/LabelBadge.tsx
import { getContrastColor } from '@/constants/labelColors';

interface LabelBadgeProps {
  name: string;
  color: string;
  size?: 'sm' | 'default';
  onClick?: () => void;
}

export function LabelBadge({ name, color, size = 'default', onClick }: LabelBadgeProps) {
  const textColor = getContrastColor(color);

  return (
    <span
      onClick={onClick}
      className={cn(
        "inline-flex items-center rounded-full font-medium",
        size === 'sm' ? 'px-1.5 py-0 text-[10px]' : 'px-2 py-0.5 text-xs',
        onClick && 'cursor-pointer hover:opacity-80'
      )}
      style={{
        backgroundColor: color,
        color: textColor,
      }}
    >
      {name}
    </span>
  );
}
```

### TaskCard Label Display
```tsx
// In TaskCard collapsed view
const MAX_VISIBLE_LABELS = 5;
const visibleLabels = labels?.slice(0, MAX_VISIBLE_LABELS) || [];
const overflowCount = (labels?.length || 0) - MAX_VISIBLE_LABELS;

{visibleLabels.length > 0 && (
  <div className="flex flex-wrap gap-1 mt-1">
    {visibleLabels.map(label => (
      <LabelBadge key={label.id} name={label.name} color={label.color} size="sm" />
    ))}
    {overflowCount > 0 && (
      <span className="text-xs text-muted-foreground">+{overflowCount}</span>
    )}
  </div>
)}
```

### Testing
- Labels persist in database
- Multiple labels can be assigned to one task
- Labels are board-specific
- Color contrast is readable for all colors
- Label picker works with keyboard
- Delete label removes from all tasks
- "+N more" shows when > 5 labels

## Story Points
5

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-31 | 0.1 | Story created from UI brainstorming session | River (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- TypeScript compilation passed with no errors
- Build completed successfully

### Completion Notes List
- Added Label and TaskLabel interfaces to types
- Updated Dexie schema to version 3 with labels and taskLabels tables
- Created color palette constants with 10 colors and contrast utility
- Created useLabels hook with full CRUD operations
- Created LabelBadge component with automatic text contrast
- Created LabelPicker with search, create, and toggle functionality
- Created LabelManager modal for board-level label management
- Integrated labels into TaskCard (collapsed/expanded views)
- Added "Labels" button to Header for managing board labels

### File List
**Created:**
- src/constants/labelColors.ts
- src/hooks/useLabels.ts
- src/components/Task/LabelBadge.tsx
- src/components/Task/LabelPicker.tsx
- src/components/Board/LabelManager.tsx

**Modified:**
- src/types/index.ts (added Label, TaskLabel interfaces)
- src/db/index.ts (version 3 schema with labels tables)
- src/components/Task/TaskCard.tsx (label display and picker)
- src/components/Header/Header.tsx (Labels button, LabelManager modal)

---

## QA Results

### Gate Decision: **PASS**

**Reviewed by:** Quinn (QA Agent)
**Date:** 2026-01-31

### Acceptance Criteria Verification

| AC | Criterion | Status | Notes |
|----|-----------|--------|-------|
| AC1 | Labels table in database | PASS | Dexie v3 with labels table |
| AC2 | TaskLabels join table | PASS | Many-to-many with compound index |
| AC3 | Label management UI | PASS | LabelManager modal from Header |
| AC4 | Pre-defined color palette | PASS | 10 colors in labelColors.ts |
| AC5 | Labels display as pills | PASS | LabelBadge component with auto-contrast |
| AC6 | Label picker in expanded view | PASS | LabelPicker with search/create |
| AC7 | Multiple labels per task | PASS | Join table supports many-to-many |
| AC8 | Board-specific labels | PASS | Labels indexed by boardId |
| AC9 | Theme compatibility | PASS | getContrastColor for text visibility |
| AC10 | Max 5 visible (+N more) | PASS | MAX_VISIBLE_LABELS = 5 in TaskCard |

### Build Verification
- TypeScript compilation: **PASS**
- Database migration: **PASS** (v2 â†’ v3)

### Notes
- Excellent contrast handling for label text colors
- Proper cascade delete when label is removed
