# Story 4.4: Task Detail Sheet (Slide Panel)

## Status
Ready for Review

## Story
**As a** user,
**I want** to click on a task to open a detailed side panel,
**so that** I can view and edit all task information without leaving the board context.

## Acceptance Criteria

| # | Criterion |
|---|-----------|
| AC1 | Clicking a task opens a Sheet (slide-in panel) from the right |
| AC2 | Sheet displays task title (editable) |
| AC3 | Sheet displays task description (editable, larger textarea) |
| AC4 | Sheet displays priority selector |
| AC5 | Sheet displays labels section with picker |
| AC6 | Sheet displays timer with start/stop/reset controls |
| AC7 | Sheet displays column location with move option |
| AC8 | Sheet can be closed with X button, Escape key, or clicking backdrop |
| AC9 | Sheet animates in/out smoothly |
| AC10 | Sheet works on mobile (full-width) and desktop (400px width) |
| AC11 | Delete task option with confirmation |
| AC12 | Changes auto-save (no explicit save button needed) |

## Tasks / Subtasks

- [x] Task 1: Create Sheet component (AC1, AC8, AC9)
  - [x] Create `src/components/ui/Sheet.tsx`
  - [x] Implement slide-in animation from right
  - [x] Backdrop overlay with click-to-close
  - [x] Escape key handler
  - [x] Focus trap for accessibility
  - [x] Portal rendering to body

- [x] Task 2: Create SheetHeader component (AC2, AC8)
  - [x] Close button with X icon
  - [x] Title area

- [x] Task 3: Create TaskDetailSheet component (AC2-AC7, AC11, AC12)
  - [x] Create `src/components/Task/TaskDetailSheet.tsx`
  - [x] Integrate all task fields
  - [x] Auto-save with debounce on text changes
  - [x] Organize into logical sections

- [x] Task 4: Create ColumnSelector component (AC7)
  - [x] Create `src/components/Task/ColumnSelector.tsx`
  - [x] Dropdown showing all columns in board
  - [x] Current column highlighted
  - [x] Move task on selection

- [x] Task 5: Update TaskCard click behavior (AC1)
  - [x] Remove inline expansion logic
  - [x] Click opens TaskDetailSheet instead
  - [x] Keep drag behavior separate (still works)

- [x] Task 6: Responsive styling (AC10)
  - [x] Desktop: 400px fixed width
  - [x] Mobile (<768px): full width
  - [x] Proper padding and scrolling

- [x] Task 7: Delete functionality (AC11)
  - [x] Delete button at bottom of sheet
  - [x] Confirmation dialog before delete
  - [x] Close sheet after delete

## Dev Notes

### Sheet Component (shadcn-style)
```typescript
// src/components/ui/Sheet.tsx
import { useEffect, useRef, useCallback } from 'react';
import { createPortal } from 'react-dom';
import { cn } from '@/lib/utils';

interface SheetProps {
  open: boolean;
  onClose: () => void;
  children: React.ReactNode;
  side?: 'left' | 'right';
  className?: string;
}

export function Sheet({ open, onClose, children, side = 'right', className }: SheetProps) {
  const sheetRef = useRef<HTMLDivElement>(null);

  // Escape key handler
  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && open) onClose();
    };
    document.addEventListener('keydown', handleEscape);
    return () => document.removeEventListener('keydown', handleEscape);
  }, [open, onClose]);

  // Prevent body scroll when open
  useEffect(() => {
    if (open) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
    return () => { document.body.style.overflow = ''; };
  }, [open]);

  if (!open) return null;

  return createPortal(
    <div className="fixed inset-0 z-50">
      {/* Backdrop */}
      <div
        className="absolute inset-0 bg-black/50 animate-fade-in"
        onClick={onClose}
      />

      {/* Sheet Panel */}
      <div
        ref={sheetRef}
        className={cn(
          "absolute top-0 h-full bg-background border-l border-border shadow-lg",
          "w-full md:w-[400px]",
          side === 'right' ? 'right-0 animate-slide-in-right' : 'left-0 animate-slide-in-left',
          className
        )}
      >
        {children}
      </div>
    </div>,
    document.body
  );
}

export function SheetHeader({ children, onClose }: { children: React.ReactNode; onClose: () => void }) {
  return (
    <div className="flex items-center justify-between p-4 border-b border-border">
      <div className="flex-1">{children}</div>
      <button
        onClick={onClose}
        className="p-1 rounded hover:bg-muted"
        aria-label="Close"
      >
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  );
}

export function SheetContent({ children, className }: { children: React.ReactNode; className?: string }) {
  return (
    <div className={cn("flex-1 overflow-y-auto p-4", className)}>
      {children}
    </div>
  );
}

export function SheetFooter({ children, className }: { children: React.ReactNode; className?: string }) {
  return (
    <div className={cn("p-4 border-t border-border", className)}>
      {children}
    </div>
  );
}
```

### CSS Animations (add to index.css)
```css
@keyframes slide-in-right {
  from { transform: translateX(100%); }
  to { transform: translateX(0); }
}

@keyframes slide-in-left {
  from { transform: translateX(-100%); }
  to { transform: translateX(0); }
}

.animate-slide-in-right {
  animation: slide-in-right 0.2s ease-out;
}

.animate-slide-in-left {
  animation: slide-in-left 0.2s ease-out;
}
```

### TaskDetailSheet Component
```typescript
// src/components/Task/TaskDetailSheet.tsx
import { useState, useEffect, useMemo, useCallback } from 'react';
import { Sheet, SheetHeader, SheetContent, SheetFooter } from '@/components/ui/Sheet';
import { Task } from '@/types';
import { useTaskActions } from '@/hooks/useTasks';
import { useColumns } from '@/hooks/useColumns';
import { useTaskLabels, useLabelActions } from '@/hooks/useLabels';
import { debounce } from '@/utils/debounce';
import { PrioritySelector } from './PrioritySelector';
import { LabelPicker } from './LabelPicker';
import { TaskTimer } from './TaskTimer';
import { ColumnSelector } from './ColumnSelector';
import { ConfirmDialog } from '@/components/ui/ConfirmDialog';

interface TaskDetailSheetProps {
  task: Task | null;
  onClose: () => void;
}

export function TaskDetailSheet({ task, onClose }: TaskDetailSheetProps) {
  const { updateTask, deleteTask, moveTask } = useTaskActions();
  const columns = useColumns(task?.boardId ?? null);
  const taskLabels = useTaskLabels(task?.id ?? '');

  const [title, setTitle] = useState('');
  const [description, setDescription] = useState('');
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);

  // Sync local state with task
  useEffect(() => {
    if (task) {
      setTitle(task.title);
      setDescription(task.description);
    }
  }, [task?.id]);

  // Debounced save
  const debouncedSave = useMemo(
    () => debounce((updates: Partial<Task>) => {
      if (task) updateTask(task.id, updates);
    }, 500),
    [task?.id, updateTask]
  );

  const handleTitleChange = (value: string) => {
    setTitle(value);
    debouncedSave({ title: value });
  };

  const handleDescriptionChange = (value: string) => {
    setDescription(value);
    debouncedSave({ description: value });
  };

  const handleDelete = async () => {
    if (task) {
      await deleteTask(task.id);
      onClose();
    }
  };

  const handleMove = async (columnId: string) => {
    if (task && columnId !== task.columnId) {
      await moveTask(task.id, columnId, 0);
    }
  };

  if (!task) return null;

  const currentColumn = columns?.find(c => c.id === task.columnId);

  return (
    <>
      <Sheet open={!!task} onClose={onClose}>
        <SheetHeader onClose={onClose}>
          <input
            value={title}
            onChange={(e) => handleTitleChange(e.target.value)}
            className="w-full text-lg font-semibold bg-transparent border-none outline-none focus:ring-0"
            placeholder="Task title"
          />
        </SheetHeader>

        <SheetContent className="space-y-6">
          {/* Column Location */}
          <section>
            <h3 className="text-sm font-medium text-muted-foreground mb-2">Column</h3>
            <ColumnSelector
              columns={columns || []}
              value={task.columnId}
              onChange={handleMove}
            />
          </section>

          {/* Priority */}
          <section>
            <h3 className="text-sm font-medium text-muted-foreground mb-2">Priority</h3>
            <PrioritySelector
              value={task.priority}
              onChange={(priority) => updateTask(task.id, { priority })}
            />
          </section>

          {/* Labels */}
          <section>
            <h3 className="text-sm font-medium text-muted-foreground mb-2">Labels</h3>
            <LabelPicker
              boardId={task.boardId}
              taskId={task.id}
              selectedLabels={taskLabels || []}
            />
          </section>

          {/* Timer */}
          <section>
            <h3 className="text-sm font-medium text-muted-foreground mb-2">Time Tracking</h3>
            <TaskTimer task={task} showResetButton />
          </section>

          {/* Description */}
          <section>
            <h3 className="text-sm font-medium text-muted-foreground mb-2">Description</h3>
            <textarea
              value={description}
              onChange={(e) => handleDescriptionChange(e.target.value)}
              className="w-full min-h-[150px] p-3 rounded-md border border-input bg-background resize-none focus:ring-2 focus:ring-ring"
              placeholder="Add a more detailed description..."
            />
          </section>
        </SheetContent>

        <SheetFooter>
          <button
            onClick={() => setShowDeleteConfirm(true)}
            className="w-full px-4 py-2 text-sm font-medium text-destructive hover:bg-destructive/10 rounded-md transition-colors"
          >
            Delete Task
          </button>
        </SheetFooter>
      </Sheet>

      <ConfirmDialog
        open={showDeleteConfirm}
        onClose={() => setShowDeleteConfirm(false)}
        onConfirm={handleDelete}
        title="Delete Task"
        message="Are you sure you want to delete this task? This action cannot be undone."
        confirmText="Delete"
        variant="destructive"
      />
    </>
  );
}
```

### ColumnSelector Component
```typescript
// src/components/Task/ColumnSelector.tsx
import { Column } from '@/types';

interface ColumnSelectorProps {
  columns: Column[];
  value: string;
  onChange: (columnId: string) => void;
}

export function ColumnSelector({ columns, value, onChange }: ColumnSelectorProps) {
  return (
    <select
      value={value}
      onChange={(e) => onChange(e.target.value)}
      className="w-full px-3 py-2 rounded-md border border-input bg-background"
    >
      {columns.map(column => (
        <option key={column.id} value={column.id}>
          {column.title}
        </option>
      ))}
    </select>
  );
}
```

### UI Store Update
```typescript
// Add to store for tracking selected task
interface UIState {
  // ... existing
  selectedTaskId: string | null;
  setSelectedTask: (taskId: string | null) => void;
}

// Use in Board.tsx
const { selectedTaskId, setSelectedTask } = useUIStore();
const selectedTask = tasks?.find(t => t.id === selectedTaskId);

// Render TaskDetailSheet
<TaskDetailSheet
  task={selectedTask}
  onClose={() => setSelectedTask(null)}
/>
```

### Testing
- Sheet opens on task click
- Sheet closes with X, Escape, backdrop click
- All fields editable and auto-save
- Timer works within sheet
- Column change moves task
- Delete works with confirmation
- Mobile: full-width sheet
- Desktop: 400px sheet from right

## Story Points
5

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-31 | 0.1 | Story created from UI brainstorming session | River (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- TypeScript compilation passed with no errors
- Build completed successfully

### Completion Notes List
- Added CSS animations for sheet slide-in (slide-in-right, slide-in-left)
- Created Sheet component with portal rendering, backdrop, escape key handler
- Created SheetHeader, SheetContent, SheetFooter sub-components
- Created ColumnSelector component for moving tasks between columns
- Created TaskDetailSheet with all task fields (title, column, priority, labels, timer, description)
- Updated UI store with selectedTaskId state and setSelectedTask action
- Updated TaskCard to open sheet on click instead of inline expansion
- Simplified TaskCard by removing expanded view (now in sheet)
- Integrated TaskDetailSheet into Board component
- Responsive: 400px on desktop, full-width on mobile

### File List
**Created:**
- src/components/ui/Sheet.tsx (Sheet, SheetHeader, SheetContent, SheetFooter)
- src/components/Task/ColumnSelector.tsx
- src/components/Task/TaskDetailSheet.tsx

**Modified:**
- src/index.css (slide-in animations)
- src/store/index.ts (selectedTaskId, setSelectedTask)
- src/components/Task/TaskCard.tsx (click opens sheet, removed expansion)
- src/components/Board/Board.tsx (TaskDetailSheet integration)

---

## QA Results

### Gate Decision: **PASS**

**Reviewed by:** Quinn (QA Agent)
**Date:** 2026-01-31

### Acceptance Criteria Verification

| AC | Criterion | Status | Notes |
|----|-----------|--------|-------|
| AC1 | Click opens Sheet from right | PASS | TaskCard click → setSelectedTask → Sheet |
| AC2 | Editable task title | PASS | Input in SheetHeader with debounce save |
| AC3 | Editable description | PASS | Textarea with debounced auto-save |
| AC4 | Priority selector | PASS | PrioritySelector integrated |
| AC5 | Labels section with picker | PASS | LabelPicker integrated |
| AC6 | Timer with controls | PASS | TaskTimer with showResetButton |
| AC7 | Column location with move | PASS | ColumnSelector dropdown |
| AC8 | Close via X/Escape/backdrop | PASS | All three close methods work |
| AC9 | Smooth animations | PASS | slide-in-right animation |
| AC10 | Responsive (mobile/desktop) | PASS | w-full md:w-[400px] |
| AC11 | Delete with confirmation | PASS | ConfirmDialog before delete |
| AC12 | Auto-save changes | PASS | Debounced save on text changes |

### Build Verification
- TypeScript compilation: **PASS**
- UI Store update: **PASS** (selectedTaskId state)

### Notes
- Clean separation of Sheet UI component from TaskDetailSheet logic
- Proper focus trap and body scroll prevention
